services:
  arrgo:
    build:
      context: .
    container_name: arrgo
    ports:
      - "5003:5003"
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgres://arrgo:${POSTGRES_PASSWORD}@db:5432/arrgo?sslmode=disable}
      - SESSION_SECRET=${SESSION_SECRET}
      - PORT=${PORT:-5003}
      - ENV=${ENV:-development}
      - DEBUG=${DEBUG:-true}
      - BUILD_VERSION=1
      - PUID=${PUID:-99}
      - PGID=${PGID:-100}
      - GOLOG_LOG_LEVEL=${GOLOG_LOG_LEVEL:-debug}
      - MOVIES_PATH=${MOVIES_PATH:-/data/movies}
      - SHOWS_PATH=${SHOWS_PATH:-/data/shows}
      - INCOMING_MOVIES_PATH=${INCOMING_MOVIES_PATH:-/data/incoming/movies}
      - INCOMING_SHOWS_PATH=${INCOMING_SHOWS_PATH:-/data/incoming/shows}
      - TMDB_API_KEY=${TMDB_API_KEY}
      - TVDB_API_KEY=${TVDB_API_KEY}
      - OPENSUBTITLES_API_KEY=${OPENSUBTITLES_API_KEY}
      - OPENSUBTITLES_USER=${OPENSUBTITLES_USER}
      - OPENSUBTITLES_PASS=${OPENSUBTITLES_PASS}
      - QBITTORRENT_URL=${QBITTORRENT_URL:-http://qbittorrent:8080}
      - QBITTORRENT_USER=${QBITTORRENT_USER}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS}
      - CLOUDFLARE_BYPASS_URL=${CLOUDFLARE_BYPASS_URL:-http://host.docker.internal:8191}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@arrgo.local}
      - ENABLE_SUBSYNC=${ENABLE_SUBSYNC:-false}
      - FFSUBSYNC_URL=${FFSUBSYNC_URL:-http://ffsubsync-api:8080}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      qbittorrent:
        condition: service_started
      # flaresolverr dependency removed - using existing Flaresolverr instance
      # If you want to run Flaresolverr in this stack, uncomment the dependency above
    volumes:
      - ./server/templates:/root/templates:ro
      - ./server/static:/root/static:ro
      - ./posters:/root/data/posters
      - ${MEDIA_PATH:-/mnt/user/media}:/data
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: arrgo-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-arrgo}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-arrgo}
    volumes:
      - ./data/db:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-arrgo} -d ${POSTGRES_DB:-arrgo}" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  qbittorrent:
    image: binhex/arch-qbittorrentvpn:latest
    container_name: arrgo-qbittorrent
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8080:8080 # qBittorrent WebUI
      - 6881:6881 # qBittorrent TCP
      - 6881:6881/udp # qBittorrent UDP
    environment:
      # VPN Provider - Private Internet Access (PIA) ONLY
      # IMPORTANT: You must manually download PIA OpenVPN config files:
      # 1. Download from: https://www.privateinternetaccess.com/openvpn/openvpn.zip
      # 2. Extract the .ovpn files to: ./config/qbittorrent/openvpn/
      # 3. The container will use these files with your PIA credentials below
      - VPN_ENABLED=${VPN_ENABLED:-yes}
      - VPN_PROV=${VPN_PROV:-pia}
      - VPN_CLIENT=openvpn
      - VPN_USER=${PIA_USER}
      - VPN_PASS=${PIA_PASSWORD}
      # VPN Server selection (optional - leave empty for auto-select)
      # You can specify a specific server .ovpn file name, or leave empty for auto
      - VPN_REMOTE=${PIA_REMOTE:-} # e.g., "us-california.privacy.network" or leave empty for auto
      # Port forwarding (PIA supports port forwarding)
      - ENABLE_PRIVOXY=no
      - LAN_NETWORK=${LAN_NETWORK:-192.168.1.0/24}
      # qBittorrent settings
      - WEBUI_PORT=8080
      - UMASK=000
      - PUID=99
      - PGID=100
      # Timezone
      - TZ=${TZ:-America/Los_Angeles}
    volumes:
      - ./config/qbittorrent:/config
      - ${MEDIA_PATH:-/mnt/user/media}/incoming:/data/incoming
    restart: unless-stopped
    labels:
      net.unraid.docker.managed: qbittorrentvpn
      net.unraid.docker.webui: http://${SERVER_IP:-localhost}:8080

  ffsubsync-api:
    build:
      context: ./ffsubsync-api
    container_name: ffsubsync-api
    environment:
      - ENABLE_SUBSYNC=${ENABLE_SUBSYNC:-false}
      - MOVIES_PATH=${MOVIES_PATH:-/data/movies}
      - SHOWS_PATH=${SHOWS_PATH:-/data/shows}
    command: >
      sh -c "if [ \"$${ENABLE_SUBSYNC}\" = \"true\" ]; then
        exec ./ffsubsync-api;
      else
        echo 'SubSync is disabled (ENABLE_SUBSYNC=false). Exiting...';
        exit 0;
      fi"
    volumes:
      - ${MEDIA_PATH:-/mnt/user/media}:/data
    restart: unless-stopped
