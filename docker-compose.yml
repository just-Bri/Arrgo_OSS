services:
  arrgo-app:
    build:
      context: .
      args:
        - BUILD_VERSION=2
    container_name: arrgo-app
    ports:
      - "5003:5003"
    environment:
      - DATABASE_URL=postgres://arrgo:arrgo@arrgo-db:5432/arrgo?sslmode=disable
      - SESSION_SECRET=change-me-in-production
      - PORT=5003
      - ENV=development
      - DEBUG=true
      - PUID=99
      - PGID=100
      - GOLOG_LOG_LEVEL=debug
      - MOVIES_PATH=/data/movies
      - SHOWS_PATH=/data/shows
      - INCOMING_MOVIES_PATH=/data/incoming/movies
      - INCOMING_SHOWS_PATH=/data/incoming/shows
      - TMDB_API_KEY=${TMDB_API_KEY}
      - TVDB_API_KEY=${TVDB_API_KEY}
      - OPENSUBTITLES_API_KEY=${OPENSUBTITLES_API_KEY}
      - OPENSUBTITLES_USER=${OPENSUBTITLES_USER}
      - OPENSUBTITLES_PASS=${OPENSUBTITLES_PASS}
      - QBITTORRENT_URL=http://arrgo_gluetun:8080
      - QBITTORRENT_USER=${QBITTORRENT_USER:-admin}
      - QBITTORRENT_PASS=${QBITTORRENT_PASS:-adminadmin}
      - INDEXER_URL=http://arrgo-indexer:5004
    depends_on:
      arrgo-db:
        condition: service_healthy
      arrgo-indexer:
        condition: service_started
      arrgo_gluetun:
        condition: service_healthy
      arrgo_qbittorrent:
        condition: service_started
    volumes:
      - ./server/templates:/root/templates:ro
      - ./server/static:/root/static:ro
      - ./posters:/root/data/posters
      - /mnt/user/media:/data
    networks:
      - arrgo-network
    restart: unless-stopped

  arrgo-db:
    image: postgres:16-alpine
    container_name: arrgo-db
    environment:
      - POSTGRES_USER=arrgo
      - POSTGRES_PASSWORD=arrgo
      - POSTGRES_DB=arrgo
    volumes:
      - arrgo-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arrgo -d arrgo"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - arrgo-network
    restart: unless-stopped

  arrgo_gluetun:
    image: qmcgaw/gluetun:latest
    container_name: arrgo_gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8080:8080 # qBittorrent WebUI
      - 6881:6881 # qBittorrent TCP
      - 6881:6881/udp # qBittorrent UDP
    volumes:
      - /mnt/user/appdata/gluetun:/gluetun
      # Mount OpenVPN config file
      - /mnt/user/appdata/gluetun/ca.protonvpn.udp.ovpn:/gluetun/ca.protonvpn.udp.ovpn:ro
    environment:
      # ProtonVPN settings - Using OpenVPN
      # Option 1: Let Gluetun handle ProtonVPN automatically (recommended)
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=openvpn
      # OpenVPN credentials (ProtonVPN username/password)
      - OPENVPN_USER=${OPENVPN_USER:-BKjGc2M8KeUcj34T}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD:-2EMy4Wl6FkG5wPzQHCVyTjwzravF2QrQ}
      # Server selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Canada}
      
      # Option 2: Use custom OpenVPN config file (uncomment below and comment out above)
      # - VPN_SERVICE_PROVIDER=custom
      # - OPENVPN_CONFIG=/gluetun/ca.protonvpn.udp.ovpn
      # - OPENVPN_USER=${OPENVPN_USER}
      # - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}
      # Port forwarding
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn
      # Firewall - allow local network
      - FIREWALL_OUTBOUND_SUBNETS=192.168.10.0/24,172.16.0.0/12
      # Timezone
      - TZ=America/Los_Angeles
      # Health check
      - HEALTH_VPN_DURATION_INITIAL=30s
    networks:
      - arrgo-network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - ping
        - -c
        - "1"
        - 1.1.1.1
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      net.unraid.docker.shell: bash
      io.hass.type: addon

  arrgo_qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: arrgo_qbittorrent
    network_mode: service:arrgo_gluetun
    depends_on:
      arrgo_gluetun:
        condition: service_healthy
    # Note: Health check would need to be on gluetun's network, so we rely on gluetun's healthcheck
    # qBittorrent WebUI should be accessible via arrgo_gluetun:8080 once gluetun is healthy
    environment:
      - PUID=99
      - PGID=100
      - TZ=America/Los_Angeles
      - WEBUI_PORT=8080
    volumes:
      - /mnt/user/appdata/dockge/stacks/arrgo/qbittorrent/config:/config
      - /mnt/user/media/incoming:/data/incoming
    restart: unless-stopped
    labels:
      net.unraid.docker.managed: qbittorrent
      net.unraid.docker.webui: http://192.168.10.11:8080

  arrgo-indexer:
    build:
      context: .
      dockerfile: ./indexer/Dockerfile
    container_name: arrgo-indexer
    ports:
      - "5004:5004"
    environment:
      - PORT=5004
      - ENV=development
      - CLOUDFLARE_BYPASS_URL=${CLOUDFLARE_BYPASS_URL:-http://192.168.10.11:8191}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - arrgo-network
    restart: unless-stopped

networks:
  arrgo-network:
    driver: bridge

volumes:
  arrgo-db-data:

